---
title: "Week 1"
author: "Group 2"
date: "2/3/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(openxlsx)
library(reshape2)
library(dplyr)
library(tidyr)
library("formattable")
library(stats)

```

## Data Cleaning
```{r, include=FALSE}
#read data
data<-read.xlsx("for_stats_peeps.xlsx")
data<-data[,-2:-6]
data<-data[,-4]
removedata<-c("MC381","MC389","MC393","MC76")
#data <- na.omit(data)
i<-1
for(i in i:4) data<-subset(data,data$ID!=removedata[i])

```

```{r, include=FALSE}
#tidy data
data2<-data[,2:8]
data2<-data2[,-3]
data2<-data2[,-5]
aggdata<-melt(data2,id=(c("Taxa","Site")))

```
Dropped 4 missing value, their IDs are MC381,MC389,MC393,MC76.

```{r}
summ <- aggdata %>%                              
  group_by(Taxa,Site,variable) %>% 
  na.omit(aggdata) %>%
  summarize(min = min(value),
            median = median(value),
            mean = mean(value),
            max = max(value),
            sd = sd(value),
            count=n())
formattable(summ)



```

## EDA
```{r,echo=FALSE,include=FALSE}
ggplot(data = aggdata, aes(x=variable,y=value, fill=variable)) + 
  geom_boxplot()+
  geom_jitter(shape=16, position=position_jitter(0.2))+
  facet_wrap(~Taxa,nrow = 1)
```

In this plot, we compared specific isotopes level in 4 taxon. It showed the level of d15N_air is less diverse than other 2 isotopes.
```{r, echo=FALSE}
ggplot(data = aggdata, aes(x=Taxa,y=value, fill=Taxa)) + 
  geom_boxplot()+
  geom_jitter(shape=16, position=position_jitter(0.2))+
  facet_wrap(~variable,nrow = 1)
```

Then we compared isotopes in two sites for each kind of animals. The plot shows that the median level of d13C_VPDB and d15N_air in BAOX is higher than Tlajinga of cottontail. Similarly, the median level of d13C_VPDB and d15N_air of hare also show difference in the boxplot.


```{r, echo=FALSE}
data_deer<-aggdata[which(aggdata$Taxa=="Deer"),]
data_Cottontail<-aggdata[which(aggdata$Taxa=="Cottontail"),]
data_Hare<-aggdata[which(aggdata$Taxa=="Hare"),]
data_Turkey<-aggdata[which(aggdata$Taxa=="Turkey"),]

deer1<-ggplot(data = data_deer, aes(x=variable,y=value, fill=variable)) + 
  geom_boxplot()+
  #geom_jitter(shape=16, position=position_jitter(0.2))+
  labs(title = 'Deer')+
  facet_wrap(~Site,nrow = 1)

deer2<-ggplot(data = data_deer, aes(x=Site,y=value, fill=Site)) + 
  geom_boxplot()+
  #geom_jitter(shape=16, position=position_jitter(0.2))+
  labs(title = 'Deer')+
  facet_wrap(~variable,nrow = 1)



cot1<-ggplot(data = data_Cottontail, aes(x=variable,y=value, fill=variable)) + 
  geom_boxplot()+
  #geom_jitter(shape=16, position=position_jitter(0.2))+
  labs(title = 'Cottontail')+
  facet_wrap(~Site,nrow = 1)

cot2<-ggplot(data = data_Cottontail, aes(x=Site,y=value, fill=Site)) + 
  geom_boxplot()+
  #geom_jitter(shape=16, position=position_jitter(0.2))+
  labs(title = 'Cottontail')+
  facet_wrap(~variable,nrow = 1)


hare1<-ggplot(data = data_Hare, aes(x=variable,y=value, fill=variable)) + 
  geom_boxplot()+
  #geom_jitter(shape=16, position=position_jitter(0.2))+
  labs(title = 'Hare')+
  facet_wrap(~Site,nrow = 1)

hare2<-ggplot(data = data_Hare, aes(x=Site,y=value, fill=Site)) + 
  geom_boxplot()+
  #geom_jitter(shape=16, position=position_jitter(0.2))+
  labs(title = 'Hare')+
  facet_wrap(~variable,nrow = 1)

turkey1<-ggplot(data = data_Turkey, aes(x=variable,y=value, fill=variable)) + 
  geom_boxplot()+
  #geom_jitter(shape=16, position=position_jitter(0.2))+
  labs(title = 'Turkey')+
  facet_wrap(~Site,nrow = 1)

turkey2<-ggplot(data = data_Turkey, aes(x=Site,y=value, fill=Site)) + 
  geom_boxplot()+
  #geom_jitter(shape=16, position=position_jitter(0.2))+
  labs(title = 'Turkey')+
  facet_wrap(~variable,nrow = 1)

```

```{r, echo=FALSE}

#gridExtra::grid.arrange(deer1,cot1,nrow=2,ncol=1)
#gridExtra::grid.arrange(hare1,turkey1,nrow=2,ncol=1)

gridExtra::grid.arrange(deer2,cot2,nrow=2,ncol=1)
gridExtra::grid.arrange(hare2,turkey2,nrow=2,ncol=1)

```

### Check Outlier

```{r}
mean(filter(aggdata,Taxa=="Hare" & Site=="BAOX" & variable=="d15N_air")$value)
sd(filter(aggdata,Taxa=="Hare" & Site=="BAOX" & variable=="d15N_air")$value)
```
outlier falls on mean +- 2sd, we believe it is not a outlier.


## Density Test

We would like to use the T-tests to find the difference of diets between two sites.

Firstly, we checked the normality.

```{r,echo=FALSE}
# check the d13C_VPDB
aggdata1 <- filter(aggdata, variable== "d13C_VPDB" & Site == "BAOX")
ggplot1 <- ggplot(aggdata1, aes(value, colour = Taxa,fill=Taxa)) + geom_density(alpha = 0.3) +
  scale_fill_brewer(palette="Dark2") +
  scale_color_brewer(palette="Dark2") +
  labs(x = "d13C_VPDB", y = "density", title = "4 kinds of animals'd13C_VPDB level distribution in BOAX")


aggdata2 <- filter(aggdata, variable== "d13C_VPDB" & Site == "Tlajinga")
ggplot2 <- ggplot(aggdata2, aes(value, colour = Taxa,fill=Taxa)) + geom_density(alpha = 0.3) +
  scale_fill_brewer(palette="Dark2") +
  scale_color_brewer(palette="Dark2") +
  labs(x = "d13C_VPDB", y = "density", title = "4 kinds of animals'd13C_VPDB level distribution in Tlajinga")

gridExtra::grid.arrange(ggplot1, ggplot2)
```

```{r}
# check the d15N_air
aggdata3 <- filter(aggdata, variable== "d15N_air" & Site == "BAOX")
ggplot3 <- ggplot(aggdata3, aes(value, colour = Taxa,fill=Taxa)) + geom_density(alpha = 0.3) +
  scale_fill_brewer(palette="Dark2") +
  scale_color_brewer(palette="Dark2") +
  labs(x = "d13C_VPDB", y = "density", title = "4 kinds of animals'd15N_air level distribution in BOAX")


aggdata4 <- filter(aggdata, variable== "d15N_air" & Site == "Tlajinga")
ggplot4 <- ggplot(aggdata4, aes(value, colour = Taxa,fill=Taxa)) + geom_density(alpha = 0.3) +
  scale_fill_brewer(palette="Dark2") +
  scale_color_brewer(palette="Dark2") +
  labs(x = "d13C_VPDB", y = "density", title = "4 kinds of animals'd15N_air level distribution in Tlajinga")

gridExtra::grid.arrange(ggplot3, ggplot4)
```


```{r}
# check the ap_13C_VPDB
aggdata5 <- filter(aggdata, variable== "ap_13C_VPDB" & Site == "BAOX")
ggplot5 <- ggplot(aggdata5, aes(value, colour = Taxa,fill=Taxa)) + geom_density(alpha = 0.3) +
  scale_fill_brewer(palette="Dark2") +
  scale_color_brewer(palette="Dark2") +
  labs(x = "d13C_VPDB", y = "density", title = "4 kinds of animals'ap_13C_VPDB level distribution in BOAX")


aggdata6 <- filter(aggdata, variable== "ap_13C_VPDB" & Site == "Tlajinga")
ggplot6 <- ggplot(aggdata6, aes(value, colour = Taxa,fill=Taxa)) + geom_density(alpha = 0.3) +
  scale_fill_brewer(palette="Dark2") +
  scale_color_brewer(palette="Dark2") +
  labs(x = "d13C_VPDB", y = "density", title = "4 kinds of animals'ap_13C_VPDB level distribution in Tlajinga")

gridExtra::grid.arrange(ggplot5, ggplot6)
```

+ Normal Distribution Test (Q-Q Plot)

Take "Turkey" and "d15N_air" as an example:
```{r,echo=FALSE}
qqnorm(aggdata[aggdata$Taxa=="Turkey"&aggdata$variable=="d15N_air",]$value)
qqline(aggdata[aggdata$Taxa=="Turkey"&aggdata$variable=="d15N_air",]$value)
```

## Mann Whitney U Test
```{r,echo=FALSE,include=FALSE}
mann <- subset(aggdata,select = -Site) %>%                              
  group_by(Taxa,variable) %>% 
  na.omit(aggdata) %>%
  summarize(rank = rank(value))
formattable(mann)
mann<- aggdata %>%                              
  group_by(Taxa,variable) %>% 
  na.omit(aggdata) %>%
  cbind(rank=mann$rank)

```




Mann-Whitney U Test for deer.

```{r}
data_deer_dc<-data_deer[which(data_deer$variable=="d13C_VPDB"),]
wilcox.test(value~Site,data=data_deer_dc)

data_deer_apc<-data_deer[which(data_deer$variable=="ap_13C_VPDB"),] %>% na.omit(data_deer)
wilcox.test(value~Site,data=data_deer_apc)

data_deer_n<-data_deer[which(data_deer$variable=="d15N_air"),]
wilcox.test(value~Site,data=data_deer_n)
```

Mann-Whitney U Test for Cottontail.

```{r}
data_cott_dc<-data_Cottontail[which(data_Cottontail$variable=="d13C_VPDB"),]
wilcox.test(value~Site,data=data_cott_dc)

data_cott_apc<-data_Cottontail[which(data_Cottontail$variable=="ap_13C_VPDB"),] 
wilcox.test(value~Site,data=data_cott_apc)

data_cott_n<-data_Cottontail[which(data_Cottontail$variable=="d15N_air"),]%>% na.omit(data_Cottontail)
wilcox.test(value~Site,data=data_cott_n)
```

Mann-Whitney U Test for Hare.

```{r}
data_hare_dc<-data_Hare[which(data_Hare$variable=="d13C_VPDB"),]
wilcox.test(value~Site,data=data_hare_dc)

data_hare_apc<-data_Hare[which(data_Hare$variable=="ap_13C_VPDB"),] 
wilcox.test(value~Site,data=data_hare_apc)

data_hare_n<-data_Hare[which(data_Hare$variable=="d15N_air"),]
wilcox.test(value~Site,data=data_hare_n)
```

Mann-Whitney U Test for Turkey.

```{r}
data_turkey_dc<-data_Turkey[which(data_Turkey$variable=="d13C_VPDB"),]
wilcox.test(value~Site,data=data_turkey_dc)

data_turkey_apc<-data_Turkey[which(data_Turkey$variable=="ap_13C_VPDB"),] 
wilcox.test(value~Site,data=data_turkey_apc)

data_turkey_n<-data_Turkey[which(data_Turkey$variable=="d15N_air"),]
wilcox.test(value~Site,data=data_turkey_n)
```

```{r}
#waining mean:
#  The impact of ties means the Wilcoxon rank sum distribution cannot be used to calculate exact p-values. If ties occur in our data and we have fewer than 50 observations, the wilcox.test function returns a normal approximated p-value along with a warning message that says “cannot compute exact p-value with ties”.


#Since this p-value is not less than 0.05, we fail to reject the null hypothesis. 


# Mann-Whitney U Test for Cottontail.

# W=52, p-value= 0.03792

# we can reject the null hypothesis:
# two sites animals are the same
```


## Next Step

We plan to try some statistic test or some regression to compare the isotopes level in two sites more precisely.